// Prisma Schema for Taseroncum.com - Construction Marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  FIRMA
  TASERON
}

enum JobStatus {
  OPEN
  CLOSED
}

enum BidStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum Category {
  KABA_INSAAT
  INCE_INSAAT
  ELEKTRIK
  TESISAT
  BOYA_BADANA
  DEKORASYON
  IZOLASYON
  CELIK_YAPI
  PEYZAJ
  RESTORASYON
}

enum ApprovalStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

// User Model
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(TASERON)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  companyProfile    CompanyProfile?
  contractorProfile ContractorProfile?
  createdJobs       JobPost[]       @relation("CreatedJobs")
  approvedJobs      JobPost[]       @relation("ApprovedJobs")
  rejectedJobs      JobPost[]       @relation("RejectedJobs")
  offeredBids       Bid[]           @relation("OfferedBids")
  givenReviews      Review[]        @relation("GivenReviews")
}

// Company Profile (Firma)
model CompanyProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  companyName String
  contactName String?
  phone       String?
  city        String
  about       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs JobPost[]
}

// Contractor Profile (Taşeron)
model ContractorProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  displayName     String
  phone           String?
  city            String
  skills          String[] @default([])
  experienceYears Int?
  about           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews Review[]
}

// Job Post (İlan)
model JobPost {
  id           String    @id @default(uuid())
  companyId    String
  title        String
  description  String
  city         String
  category     Category
  budgetMin    Int?
  budgetMax    Int?
  durationText String?
  contactPhone String?
  contactEmail String?
  status       JobStatus @default(OPEN)
  isDeleted    Boolean   @default(false)
  viewsCount   Int       @default(0)
  
  // Moderation/Approval fields
  approvalStatus  ApprovalStatus @default(DRAFT)
  createdByRole   Role           @default(FIRMA)
  createdById     String
  
  approvedAt      DateTime?
  approvedById    String?
  approvedBy      User?          @relation("ApprovedJobs", fields: [approvedById], references: [id], onDelete: SetNull)
  
  rejectedAt      DateTime?
  rejectedById    String?
  rejectedBy      User?          @relation("RejectedJobs", fields: [rejectedById], references: [id], onDelete: SetNull)
  rejectionReason String?
  
  publishedAt  DateTime?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  createdBy User           @relation("CreatedJobs", fields: [createdById], references: [id], onDelete: Cascade)
  company   CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bids      Bid[]
  reviews   Review[]
}

// Bid (Teklif) - Firma taşeron ilanına teklif verir
model Bid {
  id                String    @id @default(uuid())
  jobId             String
  offererId         String?   // FIRMA userId (teklif veren) - optional during migration
  contractorId      String    // DEPRECATED: geriye uyumluluk için
  message           String
  proposedPrice     Int?
  estimatedDuration String?
  status            BidStatus @default(PENDING)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  job     JobPost @relation(fields: [jobId], references: [id], onDelete: Cascade)
  offerer User?   @relation("OfferedBids", fields: [offererId], references: [id], onDelete: Cascade)

  @@unique([jobId, contractorId])
}

// Review (Yorum) - Firma taşerona yorum yapar
model Review {
  id           String   @id @default(uuid())
  reviewerId   String?  // FIRMA userId - optional during migration
  reviewedId   String?  // TASERON userId - optional during migration
  jobId        String?
  rating       Int      @db.SmallInt
  comment      String?
  createdAt    DateTime @default(now())

  reviewer User?              @relation("GivenReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewed ContractorProfile? @relation(fields: [reviewedId], references: [userId], onDelete: Cascade)
  job      JobPost?           @relation(fields: [jobId], references: [id], onDelete: SetNull)
}
